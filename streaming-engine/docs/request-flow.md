# Streaming Engine Request Flow

This document illustrates how the streaming engine processes audio requests with ASCII diagrams.

## Basic Request Flow

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   HTTP Client   │───▶│ Streaming Engine │───▶│ Audio Processor │
│                 │    │    (Axum)        │    │    (FFmpeg)     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
                       ┌──────────────────┐    ┌─────────────────┐
                       │  Storage Layer   │    │  Effect Chain   │
                       │ (FS/S3/GCS)      │    │   Builder       │
                       └──────────────────┘    └─────────────────┘
```

## Enhanced Request Flow (with Auth, Caching & Components)

```
┌─────────────────┐
│   HTTP Client   │
│  (Browser/CLI)  │
└─────────┬───────┘
          │ GET /unsafe/sample1.mp3?reverse=true&echo=...
          ▼
┌─────────────────────────────────────────────────────────────┐
│                    STREAMING ENGINE                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────────┐   │
│  │    Auth     │◄──│   Router    │──▶│   Middleware    │   │
│  │ Validation  │   │   (Axum)    │   │   (Logging)     │   │
│  │ HMAC/Unsafe │   └─────────────┘   └─────────────────┘   │
│  └─────────────┘           │                               │
│          │                 ▼                               │
│          │        ┌─────────────────┐                      │
│          └───────▶│  Cache Layer    │                      │
│                   │ ┌─────────────┐ │                      │
│                   │ │    Redis    │ │◄─── Cache Key:       │
│                   │ │     or      │ │     "hash_of_url"    │
│                   │ │ Filesystem  │ │                      │
│                   │ └─────────────┘ │                      │
│                   └─────────┬───────┘                      │
│                            │                               │
│                     ┌──────▼────────┐                      │
│                     │  Cache Hit?   │                      │
│                     └──────┬────────┘                      │
│                            │                               │
│               ┌────────────┴─────────────┐                 │
│               │                          │                 │
│               ▼                          ▼                 │
│     ┌─────────────────┐         ┌─────────────────────┐    │
│     │   Return        │         │    Process New      │    │
│     │ Cached Audio    │         │      Request        │    │
│     └─────────────────┘         └─────────┬───────────┘    │
│                                           │                │
│                                           ▼                │
│                                  ┌─────────────────┐       │
│                                  │ Storage Lookup  │       │
│                                  │ ┌─────────────┐ │       │
│                                  │ │ Filesystem  │ │       │
│                                  │ │     S3      │ │       │
│                                  │ │    GCS      │ │       │
│                                  │ └─────────────┘ │       │
│                                  └─────────┬───────┘       │
│                                           │                │
│                                           ▼                │
│                                  ┌─────────────────┐       │
│                                  │ Effect Builder  │       │
│                                  │ ┌─────────────┐ │       │
│                                  │ │Parse Params │ │       │
│                                  │ │Build FFmpeg │ │       │
│                                  │ │Filter Chain │ │       │
│                                  │ └─────────────┘ │       │
│                                  └─────────┬───────┘       │
│                                           │                │
│                                           ▼                │
│                                  ┌─────────────────┐       │
│                                  │ Audio Processor │       │
│                                  │ ┌─────────────┐ │       │
│                                  │ │   FFmpeg    │ │       │
│                                  │ │  Pipeline   │ │       │
│                                  │ │  (async)    │ │       │
│                                  │ └─────────────┘ │       │
│                                  └─────────┬───────┘       │
│                                           │                │
│                                           ▼                │
│                                  ┌─────────────────┐       │
│                                  │  Cache Result   │       │
│                                  │ (if enabled)    │       │
│                                  └─────────┬───────┘       │
│                                           │                │
└───────────────────────────────────────────┼────────────────┘
                                           │
                                           ▼
                                  ┌─────────────────┐
                                  │ HTTP Response   │
                                  │ ┌─────────────┐ │
                                  │ │ Audio Stream│ │
                                  │ │ Content-Type│ │
                                  │ │ chunked     │ │
                                  │ └─────────────┘ │
                                  └─────────┬───────┘
                                           │
                                           ▼
                                  ┌─────────────────┐
                                  │   HTTP Client   │
                                  │ (plays audio)   │
                                  └─────────────────┘
```

## Detailed Request Processing

```
GET /unsafe/sample1.mp3?reverse=true&echo=0.8:0.88:60:0.4&fade_in=1

┌─────────────────────────────────────────────────────────────────┐
│                        1. REQUEST PARSING                       │
├─────────────────────────────────────────────────────────────────┤
│ URL: /unsafe/sample1.mp3?reverse=true&echo=...&fade_in=1       │
│                                                                 │
│ ┌─────────────┐  ┌──────────────┐  ┌─────────────────────────┐ │
│ │   Path:     │  │   Audio:     │  │      Parameters:        │ │
│ │  /unsafe/   │  │  sample1.mp3 │  │  reverse=true           │ │
│ │             │  │              │  │  echo=0.8:0.88:60:0.4   │ │
│ │             │  │              │  │  fade_in=1              │ │
│ └─────────────┘  └──────────────┘  └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     2. STORAGE RESOLUTION                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ ┌─────────────────┐                                             │
│ │ Storage Backend │ ◄─── Resolve "sample1.mp3"                 │
│ │                 │                                             │
│ │ ┌─────────────┐ │      ┌─────────────────────────────────┐   │
│ │ │ Filesystem  │ │ OR   │         Cloud Storage          │   │
│ │ │ /testdata/  │ │      │ s3://bucket/sample1.mp3        │   │
│ │ │sample1.mp3  │ │      │ gs://bucket/sample1.mp3        │   │
│ │ └─────────────┘ │      └─────────────────────────────────┘   │
│ └─────────────────┘                                             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    3. EFFECT CHAIN BUILDING                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Parameters → FFmpeg Filter Chain:                              │
│                                                                 │
│ reverse=true     ──┐                                           │
│                    │                                           │
│ echo=0.8:0.88:60:0.4 ──┐                                       │
│                        │                                       │
│ fade_in=1         ──┐  │                                       │
│                     │  │                                       │
│                     ▼  ▼                                       │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ FFmpeg Filter: "aformat=fltp,areverse,                     │ │
│ │                aecho=0.8:0.88:60:0.4,                      │ │
│ │                afade=t=in:ss=0:d=1"                        │ │
│ └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      4. AUDIO PROCESSING                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ ┌─────────────┐     ┌─────────────┐     ┌─────────────────────┐ │
│ │   Input     │────▶│   FFmpeg    │────▶│   Processed Audio   │ │
│ │ sample1.mp3 │     │  Processing │     │     (streaming)     │ │
│ │             │     │             │     │                     │ │
│ │ [Raw Audio] │     │ ┌─────────┐ │     │ ┌─────────────────┐ │ │
│ │             │     │ │ Reverse │ │     │ │   HTTP Stream   │ │ │
│ │             │     │ │  Echo   │ │     │ │   audio/mpeg    │ │ │
│ │             │     │ │ Fade In │ │     │ │                 │ │ │
│ │             │     │ └─────────┘ │     │ └─────────────────┘ │ │
│ └─────────────┘     └─────────────┘     └─────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     5. STREAMING RESPONSE                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ HTTP Response:                                                  │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Content-Type: audio/mpeg                                    │ │
│ │ Transfer-Encoding: chunked                                  │ │
│ │                                                             │ │
│ │ [Audio Data Chunks...]                                      │ │
│ │ ██████████████████████████████████████████████              │ │
│ │                                                             │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│              Client receives processed audio stream             │
└─────────────────────────────────────────────────────────────────┘
```

## Cache Flow (Optional)

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   New Request   │───▶│  Cache Check    │───▶│  Cache Miss?    │
└─────────────────┘    │ (Redis/FS)      │    │                 │
                       └─────────────────┘    └─────────────────┘
                                                        │
                                                ┌───────┴───────┐
                                                │               │
                                                ▼               ▼
                                    ┌─────────────────┐ ┌─────────────────┐
                                    │   Cache Hit     │ │  Process Audio  │
                                    │ Return Cached   │ │  Store in Cache │
                                    └─────────────────┘ └─────────────────┘
```

## Special Endpoints

### Metadata Endpoint
```
GET /meta/unsafe/sample1.mp3

┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Client        │───▶│   FFprobe        │───▶│  JSON Metadata  │
│                 │    │   Analysis       │    │  Response       │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### Parameter Preview
```
GET /params/unsafe/sample1.mp3?reverse=true&echo=...

┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Client        │───▶│  Parse & Format  │───▶│ JSON Parameters │
│                 │    │   Parameters     │    │   Response      │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## Error Handling

```
Request → Validation → Processing → Response
    │         │            │           │
    ▼         ▼            ▼           ▼
┌─────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
│ Invalid │ │ Missing  │ │ FFmpeg   │ │ Network  │
│ Format  │ │ File     │ │ Error    │ │ Timeout  │
└─────────┘ └──────────┘ └──────────┘ └──────────┘
    │         │            │           │
    └─────────┼────────────┼───────────┘
              │            │
              ▼            ▼
    ┌─────────────────────────────┐
    │     Error Response          │
    │  HTTP 400/404/500 + JSON    │
    └─────────────────────────────┘
```
