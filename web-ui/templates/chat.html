<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Audio Engineer Demo</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/wavesurfer.js@7"></script>

    <style>
        .chat-messages {
            scrollbar-width: thin;
            scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
        }
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="h-screen flex flex-col">
        <header class="bg-white border-b border-gray-200 px-6 py-3">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-lg font-semibold text-gray-900">AI Audio Engineer</h1>
                    <p class="text-xs text-gray-500">AI-powered audio processing</p>
                </div>
                <div class="text-right text-sm">
                    <div class="text-gray-700"><span class="font-medium">{{ session_requests_remaining }}</span> requests left</div>
                    <div class="text-xs text-gray-400">Session: {{ session_id[0..8] }}...</div>
                </div>
            </div>
        </header>

        <div class="flex-1 flex flex-col min-h-0">
            <div class="flex-1 overflow-hidden">
                <div id="messages" class="h-full chat-messages overflow-y-auto px-4 py-6 space-y-4">
                    <div id="error-display" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm">
                        <span id="error-text"></span>
                    </div>

                    {% if messages.is_empty() %}
                    <div class="flex-1 flex items-center justify-center">
                        <div class="max-w-md text-center space-y-6">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900 mb-1">Welcome to the Audio Engineering Demo</h3>
                                <p class="text-gray-500 text-sm">Ask me to process audio files using natural language.</p>
                            </div>
                            <div class="space-y-2">
                                <div class="text-sm font-medium text-gray-600 mb-2">Try these examples:</div>
                                <button onclick="fillExample('Reverse Sample 1 and add echo')"
                                        class="w-full p-3 bg-white border border-gray-200 rounded-lg text-left hover:border-gray-400 text-sm">
                                    "Reverse Sample 1 and add echo"
                                </button>
                                <button onclick="fillExample('Make Sample 2 play faster with a fade in')"
                                        class="w-full p-3 bg-white border border-gray-200 rounded-lg text-left hover:border-gray-400 text-sm">
                                    "Make Sample 2 play faster with a fade in"
                                </button>
                                <button onclick="fillExample('Add chorus effect to Sample 3')"
                                        class="w-full p-3 bg-white border border-gray-200 rounded-lg text-left hover:border-gray-400 text-sm">
                                    "Add chorus effect to Sample 3"
                                </button>
                            </div>
                        </div>
                    </div>
                    {% else %}
                        {% for message in messages %}
                        <div class="flex {% if message.role == "user" %}justify-end{% endif %}">
                            <div class="max-w-[80%]">
                                <div class="{% if message.role == "user" %}bg-gray-800 text-white{% else %}bg-white border border-gray-200 text-gray-800{% endif %} rounded-lg px-4 py-3">
                                    <div class="text-sm">{{ message.content }}</div>

                                    {% if !message.audio_url.is_empty() %}
                                    <div class="mt-3 p-3 {% if message.role == "user" %}bg-white/10 border border-white/20{% else %}bg-gray-50 border border-gray-200{% endif %} rounded-lg">
                                        <div class="flex items-center space-x-3 mb-2">
                                            <button class="play-button w-9 h-9 {% if message.role == "user" %}bg-white/20 hover:bg-white/30 text-white{% else %}bg-gray-200 hover:bg-gray-300 text-gray-700{% endif %} rounded-full flex items-center justify-center text-sm"
                                                    data-audio-url="{{ message.audio_url }}"
                                                    onclick="toggleAudio(this)">
                                                <span class="play-icon">&#9654;</span>
                                            </button>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-xs font-medium {% if message.role == "user" %}text-white/80{% else %}text-gray-600{% endif %}">Processed Audio</div>
                                                <div class="audio-time text-xs font-mono {% if message.role == "user" %}text-white/60{% else %}text-gray-400{% endif %}">--:-- / --:--</div>
                                            </div>
                                            <button class="px-2 py-1 {% if message.role == "user" %}bg-white/20 hover:bg-white/30 text-white{% else %}bg-gray-200 hover:bg-gray-300 text-gray-700{% endif %} rounded text-xs"
                                                    onclick="downloadAudio('{{ message.audio_url }}')">
                                                Download
                                            </button>
                                        </div>
                                        <div class="waveform-container rounded min-h-[64px] {% if message.role == "user" %}bg-white/5{% else %}bg-gray-50{% endif %}"
                                             id="waveform-{{ loop.index }}">
                                            <div class="waveform-loading flex items-center justify-center h-16 text-xs {% if message.role == "user" %}text-white/60{% else %}text-gray-400{% endif %}">
                                                Loading waveform...
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                    <div id="thinking-indicator" class="hidden flex">
                        <div class="bg-white border border-gray-200 rounded-lg px-4 py-3 text-sm text-gray-500">
                            Thinking...
                        </div>
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-200 bg-white p-4">
                <form id="chat-form" class="{% if !redis_available %}opacity-50 pointer-events-none{% endif %}">
                    <div class="flex space-x-3">
                        <input
                            type="text"
                            name="message"
                            id="message-input"
                            maxlength="2000"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-400 focus:border-transparent outline-none text-sm"
                            placeholder="{% if !redis_available %}Chat temporarily unavailable...{% else %}Describe how you want to process your audio...{% endif %}"
                            required
                            {% if session_requests_remaining <= 0 %}disabled{% endif %}
                            {% if !redis_available %}disabled{% endif %}
                        >
                        <button
                            type="submit"
                            id="send-button"
                            class="bg-gray-800 hover:bg-gray-700 text-white px-5 py-2 rounded-lg text-sm font-medium"
                            {% if session_requests_remaining <= 0 %}disabled{% endif %}
                            {% if !redis_available %}disabled{% endif %}
                        >
                            <span class="send-text">{% if !redis_available %}Unavailable{% else %}Send{% endif %}</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentWavesurfer = null;
        let currentButton = null;
        let wavesurferCache = new Map();

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimeDisplay(button, current, duration) {
            const timeEl = button.parentElement.querySelector('.audio-time');
            if (timeEl) timeEl.textContent = `${current} / ${duration}`;
        }

        function setPlayIcon(button, playing) {
            const icon = button.querySelector('.play-icon');
            icon.textContent = playing ? '\u23F8' : '\u25B6';
        }

        function attachWavesurferEventHandlers(wavesurfer, button) {
            wavesurfer.un('loading'); wavesurfer.un('ready'); wavesurfer.un('play');
            wavesurfer.un('pause'); wavesurfer.un('finish'); wavesurfer.un('timeupdate');

            wavesurfer.on('loading', (percent) => {
                if (currentButton === button) updateTimeDisplay(button, `Loading ${Math.round(percent)}%`, '');
            });
            wavesurfer.on('ready', () => {
                if (currentButton === button) {
                    button.disabled = false;
                    updateTimeDisplay(button, '00:00', formatTime(wavesurfer.getDuration()));
                    wavesurfer.play();
                }
            });
            wavesurfer.on('play', () => { if (currentButton === button) setPlayIcon(button, true); });
            wavesurfer.on('pause', () => { if (currentButton === button) setPlayIcon(button, false); });
            wavesurfer.on('finish', () => { if (currentButton === button) stopCurrentAudio(); });
            wavesurfer.on('timeupdate', (t) => {
                if (currentButton === button) updateTimeDisplay(button, formatTime(t), formatTime(wavesurfer.getDuration()));
            });
        }

        function attachHtml5AudioEventHandlers(el, button) {
            el.onloadedmetadata = () => { updateTimeDisplay(button, '00:00', formatTime(el.duration)); button.disabled = false; setPlayIcon(button, false); };
            el.ontimeupdate = () => { if (currentButton === button) updateTimeDisplay(button, formatTime(el.currentTime), formatTime(el.duration)); };
            el.onplay = () => { if (currentButton === button) setPlayIcon(button, true); };
            el.onpause = () => { if (currentButton === button) setPlayIcon(button, false); };
            el.onended = () => { if (currentButton === button) stopCurrentAudio(); };
        }

        function stopCurrentAudio() {
            if (currentWavesurfer) {
                if (currentWavesurfer.isAudio) { currentWavesurfer.element.pause(); currentWavesurfer.element.currentTime = 0; }
                else { currentWavesurfer.pause(); currentWavesurfer.seekTo(0); }
            }
            if (currentButton) { setPlayIcon(currentButton, false); currentButton.disabled = false; }
            currentWavesurfer = null;
            currentButton = null;
        }

        function createFallbackAudio(audioUrl, container, button) {
            container.innerHTML = '<div class="p-2"><audio controls class="w-full"><source src="'+audioUrl+'"></audio></div>';
            const el = container.querySelector('audio');
            if (el) { attachHtml5AudioEventHandlers(el, button); return { isAudio: true, element: el }; }
            return null;
        }

        function toggleAudio(button) {
            const audioUrl = button.getAttribute('data-audio-url');
            const waveformContainer = button.parentElement.parentElement.querySelector('.waveform-container');

            if (currentButton === button && currentWavesurfer) {
                if (currentWavesurfer.isAudio) {
                    currentWavesurfer.element.paused ? currentWavesurfer.element.play() : currentWavesurfer.element.pause();
                } else {
                    currentWavesurfer.isPlaying() ? currentWavesurfer.pause() : currentWavesurfer.play();
                }
                return;
            }

            stopCurrentAudio();
            currentButton = button;

            let wavesurfer = wavesurferCache.get(audioUrl);
            if (!wavesurfer) {
                button.disabled = true;
                updateTimeDisplay(button, 'Loading...', '');
                waveformContainer.innerHTML = '';

                try {
                    wavesurfer = WaveSurfer.create({
                        container: waveformContainer, waveColor: '#9ca3af', progressColor: '#374151',
                        cursorColor: '#ef4444', barWidth: 2, barRadius: 3, height: 64, normalize: true
                    });
                    wavesurferCache.set(audioUrl, wavesurfer);
                    attachWavesurferEventHandlers(wavesurfer, button);
                    wavesurfer.on('error', (error) => {
                        console.error('Wavesurfer error, falling back:', error);
                        if (currentButton === button) {
                            wavesurferCache.delete(audioUrl);
                            const fb = createFallbackAudio(audioUrl, waveformContainer, button);
                            if (fb) { wavesurferCache.set(audioUrl, fb); currentWavesurfer = fb; }
                            else { button.disabled = false; updateTimeDisplay(button, 'Error', ''); currentWavesurfer = null; currentButton = null; }
                        }
                    });
                    wavesurfer.load(audioUrl);
                } catch (error) {
                    console.error('Error creating wavesurfer:', error);
                    const fb = createFallbackAudio(audioUrl, waveformContainer, button);
                    if (fb) { wavesurferCache.set(audioUrl, fb); wavesurfer = fb; currentWavesurfer = fb; }
                    else { button.disabled = false; updateTimeDisplay(button, 'Error', ''); return; }
                }
            } else {
                button.disabled = false;
                if (wavesurfer.isAudio) {
                    attachHtml5AudioEventHandlers(wavesurfer.element, button);
                    updateTimeDisplay(button, '00:00', formatTime(wavesurfer.element.duration || 0));
                    try { wavesurfer.element.play(); } catch(e) { console.error(e); }
                } else {
                    attachWavesurferEventHandlers(wavesurfer, button);
                    updateTimeDisplay(button, '00:00', formatTime(wavesurfer.getDuration()));
                    try { wavesurfer.play(); } catch(e) { console.error(e); }
                }
            }
            currentWavesurfer = wavesurfer;
        }

        function downloadAudio(audioUrl) {
            const link = document.createElement('a');
            link.href = audioUrl;
            link.download = `audio-${Date.now()}.mp3`;
            link.click();
        }

        function fillExample(text) {
            document.getElementById('message-input').value = text;
            document.getElementById('message-input').focus();
        }

        function addErrorMessage(message) {
            const d = document.getElementById('error-display');
            document.getElementById('error-text').textContent = message;
            d.classList.remove('hidden');
            setTimeout(() => d.classList.add('hidden'), 5000);
        }

        function addThinkingMessage() {
            document.getElementById('thinking-indicator').classList.remove('hidden');
            scrollToBottom();
        }

        function removeThinkingMessage() {
            document.getElementById('thinking-indicator').classList.add('hidden');
        }

        function addMessageToUI(role, content) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : ''}`;
            div.innerHTML = `<div class="max-w-[80%]"><div class="${role === 'user' ? 'bg-gray-800 text-white' : 'bg-white border border-gray-200 text-gray-800'} rounded-lg px-4 py-3"><div class="text-sm">${content}</div></div></div>`;
            container.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            const c = document.getElementById('messages');
            c.scrollTop = c.scrollHeight;
        }

        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const btn = document.getElementById('send-button');
            const message = input.value.trim();
            if (!message) return;
            if (message.length > 2000) { addErrorMessage('Message too long. Please keep it under 2000 characters.'); return; }
            if (btn.disabled || input.disabled) return;

            input.disabled = true; btn.disabled = true;
            btn.querySelector('.send-text').textContent = 'Sending...';
            addMessageToUI('user', message);
            input.value = '';
            addThinkingMessage();

            try {
                const formData = new URLSearchParams();
                formData.append('message', message);
                const response = await fetch('/chat', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: formData });
                if (response.ok) { window.location.reload(); }
                else { throw new Error('Server error'); }
            } catch (error) {
                console.error('Chat submission failed:', error);
                removeThinkingMessage();
                addErrorMessage('Failed to send message. Please try again.');
            } finally {
                input.disabled = false; btn.disabled = false;
                btn.querySelector('.send-text').textContent = 'Send';
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.waveform-container').forEach((container, index) => {
                const parent = container.parentElement;
                const button = parent?.querySelector('.play-button');
                const audioUrl = button?.getAttribute('data-audio-url');
                if (audioUrl && button) {
                    setTimeout(() => {
                        if (!wavesurferCache.has(audioUrl)) {
                            try {
                                const ws = WaveSurfer.create({
                                    container, waveColor: '#9ca3af', progressColor: '#374151',
                                    cursorColor: '#ef4444', barWidth: 2, barRadius: 3, height: 64, normalize: true
                                });
                                wavesurferCache.set(audioUrl, ws);
                                ws.on('ready', () => {
                                    updateTimeDisplay(button, '00:00', formatTime(ws.getDuration()));
                                    const l = container.querySelector('.waveform-loading');
                                    if (l) l.style.display = 'none';
                                });
                                ws.on('error', (err) => {
                                    console.error('Pre-load error:', err);
                                    wavesurferCache.delete(audioUrl);
                                    const l = container.querySelector('.waveform-loading');
                                    if (l) l.textContent = 'Failed to load waveform';
                                });
                                ws.load(audioUrl);
                            } catch (e) { console.error('Error pre-loading wavesurfer:', e); }
                        }
                    }, index * 500);
                }
            });
            if (document.querySelectorAll('#messages > div').length > 2) scrollToBottom();

            const err = new URLSearchParams(window.location.search).get('error');
            if (err) {
                const msgs = { message_too_long: 'Message too long (max 2000 chars).', redis_unavailable: 'Service temporarily unavailable.', quota_exceeded: 'Daily limit reached. Try again tomorrow.', chat_failed: 'Error processing message. Try again.' };
                if (msgs[err]) alert(msgs[err]);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') stopCurrentAudio(); });
    </script>
</body>
</html>
